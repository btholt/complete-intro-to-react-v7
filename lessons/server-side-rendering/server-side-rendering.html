<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Server Side Rendering ‚Äì Complete Intro to React v7</title><meta name="description" content="Come learn React from Brian Holt, a veteran React.js developer on Frontend Masters"/><meta name="og:description" content="Come learn React from Brian Holt, a veteran React.js developer on Frontend Masters"/><meta name="og:title" content="Server Side Rendering ‚Äì Complete Intro to React v7"/><meta name="og:image" content="/complete-intro-to-react-v7/images/social-share-cover.jpg"/><meta name="twitter:card" content="summary_large_image"/><meta name="next-head-count" content="8"/><link rel="preload" href="/complete-intro-to-react-v7/_next/static/css/67df7a96ec96d085.css" as="style"/><link rel="stylesheet" href="/complete-intro-to-react-v7/_next/static/css/67df7a96ec96d085.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/complete-intro-to-react-v7/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/complete-intro-to-react-v7/_next/static/chunks/webpack-f38182d1d59da4a6.js" defer=""></script><script src="/complete-intro-to-react-v7/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/complete-intro-to-react-v7/_next/static/chunks/main-d7e753d798e31e42.js" defer=""></script><script src="/complete-intro-to-react-v7/_next/static/chunks/pages/_app-50fe8f3e06795df4.js" defer=""></script><script src="/complete-intro-to-react-v7/_next/static/chunks/pages/lessons/%5Bsection%5D/%5Bslug%5D-eca31f262a16e91b.js" defer=""></script><script src="/complete-intro-to-react-v7/_next/static/ug4-t9ZxktoWmqoFABkyh/_buildManifest.js" defer=""></script><script src="/complete-intro-to-react-v7/_next/static/ug4-t9ZxktoWmqoFABkyh/_ssgManifest.js" defer=""></script><script src="/complete-intro-to-react-v7/_next/static/ug4-t9ZxktoWmqoFABkyh/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="remix-app"><header class="navbar"><h1 class="navbar-brand"><a href="/complete-intro-to-react-v7">Complete Intro to React v7</a></h1><div class="navbar-info"><a href="https://frontendmasters.com/courses/complete-react-v7/" class="cta-btn">Watch on Frontend Masters</a></div></header><div class="content-container"><div class="main"><div class="lesson-container"><div class="lesson"><div class="lesson-content"><blockquote>
<p>Please start with a fresh copy of this app: <a href="https://github.com/btholt/citr-v7-project/tree/master/12-portals-and-refs">Adopt Me!</a></p>
</blockquote>
<p>Performance is a central concern for front end developers. We should always be striving to serve the leanest web apps that perform faster than humans can think. This is as much a game of psychology as it is a a technological challenge. It&#39;s a challenge of loading the correct content first so a user can see a site and begin to make a decision of what they want to do (scroll down, click a button, log in, etc.) and then be prepared for that action before they make that decision.</p>
<p>Enter server-side rendering. This is a technique where you run React on your Node.js server <em>before</em> you serve the request to the user and send down the first rendering of your website already done. This saves precious milliseconds+ on your site because otherwise the user has to download the HTML, then download the JavaScript, then execute the JS to get the app. In this case, they&#39;ll just download the HTML and see the first rendered page while React is loading in the background.</p>
<p>While the total time to when the page is actually interactive is comparable, if a bit slower, the time to when the user <em>sees</em> something for the first time should be much faster, hence why this is a popular technique. So let&#39;s give it a shot.</p>
<p>First, we need to remove all references to <code>window</code> or anything browser related from a path that <em>could</em> be called in Node. That means whenever we reference <code>window</code>, it&#39;ll have to be inside componentDidMount since componentDidMount doesn&#39;t get called in Node.</p>
<p>We&#39;ll also have change where our app gets rendered. Make a new file called ClientApp.js. Put in there:</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">import</span> { hydrate } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react-dom&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">BrowserRouter</span>, <span class="hljs-title class_">BrowserRouter</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Router</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react-router-dom&quot;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./App&quot;</span>;

<span class="hljs-title function_">hydrate</span>(
  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">BrowserRouter</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">BrowserRouter</span>&gt;</span></span>,
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;root&quot;</span>)
);
</code></pre>
<p>This code will only get run in the browser, so any sort of browser related stuff can safely be done here (like analytics.) We&#39;re also using <code>ReactDOM.hydrate</code> instead of <code>ReactDOM.render</code> because this will hydrate existing markup with React magic ‚ú® rather than render it from scratch.</p>
<p>Because ClientApp.js will now be the entry point to the app, not App.js, we&#39;ll need to fix that in the script tag in index.html. Change it from App.js to ClientApp.js</p>
<p>Let&#39;s go fix App.js now:</p>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// remove react-dom import</span>
<span class="hljs-comment">// remove BrowserRouter as Router from react-router-dom import</span>

<span class="hljs-comment">// replace render at bottom</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;
</code></pre>
<p>We need a few more modules. Run <code>npm install express@4.17.3</code> to get the framework we need for Node.</p>
<p>Go change your index.html to use ClientApp.js instead of App.js</p>
<pre><code class="hljs language-html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;module&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;./ClientApp.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>Now in your package.json, add the following to your <code>&quot;scripts&quot;</code></p>
<pre><code class="hljs language-json"><span class="hljs-attr">&quot;build&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;parcel build&quot;</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">&quot;start&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;npm -s run build &amp;&amp; node dist/backend/index.js&quot;</span>
</code></pre>
<p>And then add this top level item to your package.json:</p>
<pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;targets&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;frontend&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;src/index.html&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;publicUrl&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/frontend&quot;</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;backend&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;server/index.js&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;optimize&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">false</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;context&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;node&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;engines&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">&quot;node&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&gt;=16&quot;</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>This will allow us to build the app into static (pre-compiled, non-dev) assets and then start our server. This will then let us run Parcel on our Node.js code too so we can use our React code directly in our App as well.</p>
<p>Let&#39;s finally go write our Node.js server:</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;express&quot;</span>;
<span class="hljs-keyword">import</span> { renderToString } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react-dom/server&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">StaticRouter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react-router-dom/server&quot;</span>;
<span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;fs&quot;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;../src/App&quot;</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PORT</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span> || <span class="hljs-number">3000</span>;

<span class="hljs-keyword">const</span> html = fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">&quot;dist/frontend/index.html&quot;</span>).<span class="hljs-title function_">toString</span>();

<span class="hljs-keyword">const</span> parts = html.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;not rendered&quot;</span>);

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();

app.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;/frontend&quot;</span>, express.<span class="hljs-title function_">static</span>(<span class="hljs-string">&quot;dist/frontend&quot;</span>));
app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> reactMarkup = (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">StaticRouter</span> <span class="hljs-attr">location</span>=<span class="hljs-string">{req.url}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">StaticRouter</span>&gt;</span></span>
  );

  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">`<span class="hljs-subst">${parts[<span class="hljs-number">0</span>]}</span><span class="hljs-subst">${renderToString(reactMarkup)}</span><span class="hljs-subst">${parts[<span class="hljs-number">1</span>]}</span>`</span>);
  res.<span class="hljs-title function_">end</span>();
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`listening on http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
app.<span class="hljs-title function_">listen</span>(<span class="hljs-variable constant_">PORT</span>);
</code></pre>
<ul>
<li>[Express.js][ex] is a Node.js web server framework. It&#39;s the most common one and a simple one to learn.</li>
<li>We&#39;ll be listening on port 3000 (<a href="http://locahost:**3000">http://locahost:**3000</a>**) unless a environment variable is passed in saying otherwise. We do this because if you try to deploy this, you&#39;ll need to watch for PORT.</li>
<li>We&#39;ll statically serve what Parcel built.</li>
<li>Anything that Parcel <em>doesn&#39;t</em> serve, will be given our index.html. This lets the client-side app handle all the routing.</li>
<li>We read the compiled HTML doc and split it around our <code>not rendered</code> statement. Then we can slot in our markup in between the divs, right where it should be. Another strategy you can do here is to make an <code>Html.js</code> component that renders the outer shell of your app. This for now suits our needs</li>
<li>We use renderToString to take our app and render it to a string we can serve as HTML, sandwiched inside our outer HTML.</li>
</ul>
<blockquote>
<p>This code won&#39;t 404 or 500 on bad requests. It&#39;s a lot involved to do that with React Router v6. <a href="https://github.com/remix-run/react-router/issues/8286#issuecomment-963845433">See here</a> to learn more.</p>
</blockquote>
<p>Run <code>npm run start</code> and then open <a href="http://localhost:3000">http://localhost:3000</a> to see your server side rendered app. Notice it displays markup almost instantly.</p>
<blockquote>
<p>üèÅ <a href="https://github.com/btholt/citr-v7-project/tree/master/server-side-rendering-1">Click here to see the state of the project up until now: server-side-rendering-1</a></p>
</blockquote>
</div><div class="lesson-links"><a href="/complete-intro-to-react-v7/lessons/code-splitting/code-splitting" class="prev">‚Üê Previous</a><a href="/complete-intro-to-react-v7/lessons/server-side-rendering/streaming-markup" class="next">Next ‚Üí</a></div></div><div class="details-bg"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="154" height="154" viewBox="0 0 154 154"><defs><clipPath id="clip-path"><rect id="Rectangle_2238" data-name="Rectangle 2238" width="154" height="154" transform="translate(9467 350)" fill="#fff" stroke="#707070" stroke-width="1"></rect></clipPath><clipPath id="clip-corner-image-active"><rect width="154" height="154"></rect></clipPath></defs><g id="corner-image-active" clip-path="url(#clip-corner-image-active)"><g id="Corner-image-active-2" data-name="Corner-image-active" transform="translate(-9467 -350)" clip-path="url(#clip-path)"><path id="Subtraction_34" data-name="Subtraction 34" d="M-3857.365,1740.766h0l-7.07-7.07,12.89-12.89v14.142l-5.818,5.818Zm-14.142-14.142h0l-7.071-7.07,27.033-27.033v14.143l-19.96,19.96Zm-14.143-14.143h0l-7.07-7.069,41.175-41.175v14.142Zm-14.142-14.142h0l-7.07-7.069,55.317-55.317v14.142Zm-14.142-14.142h0l-7.07-7.069,69.459-69.459v14.142Zm-14.142-14.142h0l-7.07-7.069,76.739-76.739h6.862v7.28Zm-14.143-14.143h0l-7.07-7.069,62.6-62.6h14.142Zm-14.142-14.142h0l-7.07-7.069,48.454-48.454h14.142Zm-14.142-14.142h0l-7.07-7.069,34.312-34.312h14.142Zm-14.142-14.142h0l-7.07-7.069,20.17-20.17h14.142Zm-14.142-14.142h0l-7.071-7.071,6.027-6.027h14.144l-13.1,13.1Zm367.24-56.114v-.909l.455.455-.453.453Z" transform="translate(13472.546 -1236.766)" fill="var(--corner-fill)"></path></g></g></svg></div></div></div></div><footer class="footer"><ul class="socials"><li class="social"><a href="https://twitter.com/holtbt"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="40" height="32" viewBox="0 0 40 32"><defs><clipPath id="clip-twitter-social"><rect width="40" height="32"></rect></clipPath></defs><g id="twitter-social" clip-path="url(#clip-twitter-social)"><g id="Group_269" data-name="Group 269" transform="translate(-230.23 -1140.849)"><path id="Path_419" data-name="Path 419" d="M266.12,1148.861v1.035a23.092,23.092,0,0,1-1.507,8.1,24.08,24.08,0,0,1-4.475,7.381,22.175,22.175,0,0,1-7.306,5.4,24.129,24.129,0,0,1-10,2.07,23.7,23.7,0,0,1-6.667-.945,22.83,22.83,0,0,1-5.936-2.655q.959.091,1.963.09a16.518,16.518,0,0,0,5.434-.9,17.111,17.111,0,0,0,4.749-2.52,8.275,8.275,0,0,1-4.749-1.643,7.8,7.8,0,0,1-2.877-3.983,8.268,8.268,0,0,0,1.507.135,8.58,8.58,0,0,0,2.146-.27,8.16,8.16,0,0,1-5.685-4.344,8.326,8.326,0,0,1-.89-3.578v-.135a7.775,7.775,0,0,0,3.744,1.035,8.183,8.183,0,0,1-2.671-2.9,7.817,7.817,0,0,1-.982-3.848,7.948,7.948,0,0,1,1.1-4.05,23.53,23.53,0,0,0,16.895,8.46,9.221,9.221,0,0,1-.183-1.845,7.787,7.787,0,0,1,1.1-4.05,8.216,8.216,0,0,1,2.991-2.948,7.991,7.991,0,0,1,4.087-1.1,8.184,8.184,0,0,1,5.982,2.566,16.087,16.087,0,0,0,5.205-1.98,7.784,7.784,0,0,1-1.393,2.588,8.4,8.4,0,0,1-2.215,1.913,16.856,16.856,0,0,0,4.749-1.305A17.032,17.032,0,0,1,266.12,1148.861Z" fill="var(--icons)"></path></g></g></svg></a></li><li class="social"><a href="https://github.com/btholt"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 32 32"><defs><clipPath id="clip-github-social"><rect width="32" height="32"></rect></clipPath></defs><g id="github-social" clip-path="url(#clip-github-social)"><g id="Group_272" data-name="Group 272" transform="translate(13522.5 -6994)"><path id="Subtraction_33" data-name="Subtraction 33" d="M-24967.5,8041a15.9,15.9,0,0,1-11.312-4.688A15.893,15.893,0,0,1-24983.5,8025a15.893,15.893,0,0,1,4.689-11.315A15.894,15.894,0,0,1-24967.5,8009a15.894,15.894,0,0,1,11.313,4.686A15.893,15.893,0,0,1-24951.5,8025a15.893,15.893,0,0,1-4.689,11.313A15.9,15.9,0,0,1-24967.5,8041Zm-3.781-4.571h0v3.918h7.895v-6.665a1.836,1.836,0,0,0-1.2-1.718c5.1-.617,7.467-2.975,7.467-7.424a7.176,7.176,0,0,0-1.637-4.728,6.74,6.74,0,0,0,.275-1.812,4.34,4.34,0,0,0-.52-2.452.574.574,0,0,0-.359-.1c-1.061,0-3.465,1.411-3.936,1.694a16.644,16.644,0,0,0-4.2-.489,16.379,16.379,0,0,0-3.969.445c-.846-.5-2.91-1.649-3.859-1.649a.566.566,0,0,0-.354.095,4.3,4.3,0,0,0-.521,2.452,6.7,6.7,0,0,0,.244,1.718,7.346,7.346,0,0,0-1.6,4.822,7.263,7.263,0,0,0,1.533,4.985c1.193,1.359,3.115,2.165,5.871,2.464a1.826,1.826,0,0,0-1.129,1.693v.5h0l-.006,0a7.121,7.121,0,0,1-2.033.363,2.608,2.608,0,0,1-.965-.158,4.438,4.438,0,0,1-1.836-1.881,2.361,2.361,0,0,0-1.248-1.091,3.472,3.472,0,0,0-1.217-.3.584.584,0,0,0-.545.224.282.282,0,0,0,.027.367,1.875,1.875,0,0,0,.447.307,4.732,4.732,0,0,1,.561.355,10.726,10.726,0,0,1,1.682,2.755c.043.092.078.163.105.217a3.876,3.876,0,0,0,2.42,1.185,6.036,6.036,0,0,0,.607.025c.875,0,1.988-.124,2-.125Z" transform="translate(11461 -1015)" fill="var(--icons)"></path><g id="Ellipse_670" data-name="Ellipse 670" transform="translate(-13522.5 6994)" fill="none" stroke="var(--icons)" stroke-width="1"><circle cx="16" cy="16" r="16" stroke="none"></circle><circle cx="16" cy="16" r="15.5" fill="none"></circle></g></g></g></svg></a></li><li class="social"><a href="https://linkedin.com/in/btholt"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 32 32"><defs><clipPath id="clip-linkedin-social"><rect width="32" height="32"></rect></clipPath></defs><g id="linkedin-social" clip-path="url(#clip-linkedin-social)"><g id="Group_270" data-name="Group 270" transform="translate(-86.349 -633.073)"><path id="Path_375" data-name="Path 375" d="M115.789,633.073a2.324,2.324,0,0,1,1.682.676,2.194,2.194,0,0,1,.695,1.627V662.8a2.131,2.131,0,0,1-.695,1.609,2.314,2.314,0,0,1-1.646.659H88.69a2.307,2.307,0,0,1-1.646-.659,2.128,2.128,0,0,1-.695-1.609V635.376a2.19,2.19,0,0,1,.695-1.627,2.322,2.322,0,0,1,1.682-.676h27.063Zm-20.224,9.672a2.561,2.561,0,0,0,0-3.584,2.658,2.658,0,0,0-1.938-.712,2.724,2.724,0,0,0-1.957.712,2.371,2.371,0,0,0-.75,1.792,2.4,2.4,0,0,0,.731,1.792,2.605,2.605,0,0,0,1.9.713h.037A2.7,2.7,0,0,0,95.565,642.745ZM96,645.434H91.213V659.88H96Zm17.3,6.144a7.007,7.007,0,0,0-1.573-4.9,5.68,5.68,0,0,0-6.839-.769,5.663,5.663,0,0,0-1.426,1.573v-2.048H98.674q.036.841,0,7.717v6.728h4.791V651.8a3.592,3.592,0,0,1,.146-1.17,2.913,2.913,0,0,1,.878-1.206,2.429,2.429,0,0,1,1.609-.549,2.108,2.108,0,0,1,1.865.914,4.265,4.265,0,0,1,.549,2.341v7.752H113.3Z" fill="var(--icons)"></path></g></g></svg></a></li><li class="social"><div class="terms"><p>Content Licensed Under CC-BY-NC-4.0</p><p>Code Samples and Excercises Licensed Under Apache 2.0</p><p>Site Designed by<!-- --> <a href="https://www.alexdanielson.com/">Alex Danielson</a></p></div></li></ul></footer></div><script async="" defer="" src="https://a.holt.courses/latest.js" data-hostname="react-v7.holt.courses"></script><noscript><img src="https://a.holt.courses/noscript.gif?hostname=react-v7.holt.courses" alt="" referrerPolicy="no-referrer-when-downgrade"/></noscript></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"attributes":{"description":"Server side rendering is a key technique to achieving quick page loads, particularly for slow networks and low powered devices. Brian shows you a simple approach to using SSR for your React app."},"html":"\u003cblockquote\u003e\n\u003cp\u003ePlease start with a fresh copy of this app: \u003ca href=\"https://github.com/btholt/citr-v7-project/tree/master/12-portals-and-refs\"\u003eAdopt Me!\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003ePerformance is a central concern for front end developers. We should always be striving to serve the leanest web apps that perform faster than humans can think. This is as much a game of psychology as it is a a technological challenge. It\u0026#39;s a challenge of loading the correct content first so a user can see a site and begin to make a decision of what they want to do (scroll down, click a button, log in, etc.) and then be prepared for that action before they make that decision.\u003c/p\u003e\n\u003cp\u003eEnter server-side rendering. This is a technique where you run React on your Node.js server \u003cem\u003ebefore\u003c/em\u003e you serve the request to the user and send down the first rendering of your website already done. This saves precious milliseconds+ on your site because otherwise the user has to download the HTML, then download the JavaScript, then execute the JS to get the app. In this case, they\u0026#39;ll just download the HTML and see the first rendered page while React is loading in the background.\u003c/p\u003e\n\u003cp\u003eWhile the total time to when the page is actually interactive is comparable, if a bit slower, the time to when the user \u003cem\u003esees\u003c/em\u003e something for the first time should be much faster, hence why this is a popular technique. So let\u0026#39;s give it a shot.\u003c/p\u003e\n\u003cp\u003eFirst, we need to remove all references to \u003ccode\u003ewindow\u003c/code\u003e or anything browser related from a path that \u003cem\u003ecould\u003c/em\u003e be called in Node. That means whenever we reference \u003ccode\u003ewindow\u003c/code\u003e, it\u0026#39;ll have to be inside componentDidMount since componentDidMount doesn\u0026#39;t get called in Node.\u003c/p\u003e\n\u003cp\u003eWe\u0026#39;ll also have change where our app gets rendered. Make a new file called ClientApp.js. Put in there:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { hydrate } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;react-dom\u0026quot;\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { \u003cspan class=\"hljs-title class_\"\u003eBrowserRouter\u003c/span\u003e, \u003cspan class=\"hljs-title class_\"\u003eBrowserRouter\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eRouter\u003c/span\u003e } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;react-router-dom\u0026quot;\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eApp\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;./App\u0026quot;\u003c/span\u003e;\n\n\u003cspan class=\"hljs-title function_\"\u003ehydrate\u003c/span\u003e(\n  \u003cspan class=\"language-xml\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003eBrowserRouter\u003c/span\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003eApp\u003c/span\u003e /\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003eBrowserRouter\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e,\n  \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003egetElementById\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;root\u0026quot;\u003c/span\u003e)\n);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis code will only get run in the browser, so any sort of browser related stuff can safely be done here (like analytics.) We\u0026#39;re also using \u003ccode\u003eReactDOM.hydrate\u003c/code\u003e instead of \u003ccode\u003eReactDOM.render\u003c/code\u003e because this will hydrate existing markup with React magic ‚ú® rather than render it from scratch.\u003c/p\u003e\n\u003cp\u003eBecause ClientApp.js will now be the entry point to the app, not App.js, we\u0026#39;ll need to fix that in the script tag in index.html. Change it from App.js to ClientApp.js\u003c/p\u003e\n\u003cp\u003eLet\u0026#39;s go fix App.js now:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// remove react-dom import\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e// remove BrowserRouter as Router from react-router-dom import\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e// replace render at bottom\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003edefault\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eApp\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWe need a few more modules. Run \u003ccode\u003enpm install express@4.17.3\u003c/code\u003e to get the framework we need for Node.\u003c/p\u003e\n\u003cp\u003eGo change your index.html to use ClientApp.js instead of App.js\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-html\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003escript\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003etype\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;module\u0026quot;\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003esrc\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;./ClientApp.js\u0026quot;\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003escript\u003c/span\u003e\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow in your package.json, add the following to your \u003ccode\u003e\u0026quot;scripts\u0026quot;\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-json\"\u003e\u003cspan class=\"hljs-attr\"\u003e\u0026quot;build\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;parcel build\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003e\u0026quot;start\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;npm -s run build \u0026amp;\u0026amp; node dist/backend/index.js\u0026quot;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAnd then add this top level item to your package.json:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-json\"\u003e\u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003e\u0026quot;targets\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\u0026quot;frontend\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003e\u0026quot;source\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e\u0026quot;src/index.html\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003e\u0026quot;publicUrl\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;/frontend\u0026quot;\u003c/span\u003e\n    \u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\u0026quot;backend\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003e\u0026quot;source\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;server/index.js\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003e\u0026quot;optimize\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efalse\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003e\u0026quot;context\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;node\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003e\u0026quot;engines\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003e\u0026quot;node\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;\u0026gt;=16\u0026quot;\u003c/span\u003e\n      \u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis will allow us to build the app into static (pre-compiled, non-dev) assets and then start our server. This will then let us run Parcel on our Node.js code too so we can use our React code directly in our App as well.\u003c/p\u003e\n\u003cp\u003eLet\u0026#39;s finally go write our Node.js server:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e express \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;express\u0026quot;\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { renderToString } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;react-dom/server\u0026quot;\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { \u003cspan class=\"hljs-title class_\"\u003eStaticRouter\u003c/span\u003e } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;react-router-dom/server\u0026quot;\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e fs \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;fs\u0026quot;\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eApp\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;../src/App\u0026quot;\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003ePORT\u003c/span\u003e = process.\u003cspan class=\"hljs-property\"\u003eenv\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ePORT\u003c/span\u003e || \u003cspan class=\"hljs-number\"\u003e3000\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e html = fs.\u003cspan class=\"hljs-title function_\"\u003ereadFileSync\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;dist/frontend/index.html\u0026quot;\u003c/span\u003e).\u003cspan class=\"hljs-title function_\"\u003etoString\u003c/span\u003e();\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e parts = html.\u003cspan class=\"hljs-title function_\"\u003esplit\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;not rendered\u0026quot;\u003c/span\u003e);\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e app = \u003cspan class=\"hljs-title function_\"\u003eexpress\u003c/span\u003e();\n\napp.\u003cspan class=\"hljs-title function_\"\u003euse\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;/frontend\u0026quot;\u003c/span\u003e, express.\u003cspan class=\"hljs-title function_\"\u003estatic\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;dist/frontend\u0026quot;\u003c/span\u003e));\napp.\u003cspan class=\"hljs-title function_\"\u003euse\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003ereq, res\u003c/span\u003e) =\u0026gt;\u003c/span\u003e {\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e reactMarkup = (\n    \u003cspan class=\"language-xml\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003eStaticRouter\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003elocation\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e{req.url}\u003c/span\u003e\u0026gt;\u003c/span\u003e\n      \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003eApp\u003c/span\u003e /\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003eStaticRouter\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n  );\n\n  res.\u003cspan class=\"hljs-title function_\"\u003esend\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e`\u003cspan class=\"hljs-subst\"\u003e${parts[\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e]}\u003c/span\u003e\u003cspan class=\"hljs-subst\"\u003e${renderToString(reactMarkup)}\u003c/span\u003e\u003cspan class=\"hljs-subst\"\u003e${parts[\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e]}\u003c/span\u003e`\u003c/span\u003e);\n  res.\u003cspan class=\"hljs-title function_\"\u003eend\u003c/span\u003e();\n});\n\n\u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e`listening on http://localhost:\u003cspan class=\"hljs-subst\"\u003e${PORT}\u003c/span\u003e`\u003c/span\u003e);\napp.\u003cspan class=\"hljs-title function_\"\u003elisten\u003c/span\u003e(\u003cspan class=\"hljs-variable constant_\"\u003ePORT\u003c/span\u003e);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cul\u003e\n\u003cli\u003e[Express.js][ex] is a Node.js web server framework. It\u0026#39;s the most common one and a simple one to learn.\u003c/li\u003e\n\u003cli\u003eWe\u0026#39;ll be listening on port 3000 (\u003ca href=\"http://locahost:**3000\"\u003ehttp://locahost:**3000\u003c/a\u003e**) unless a environment variable is passed in saying otherwise. We do this because if you try to deploy this, you\u0026#39;ll need to watch for PORT.\u003c/li\u003e\n\u003cli\u003eWe\u0026#39;ll statically serve what Parcel built.\u003c/li\u003e\n\u003cli\u003eAnything that Parcel \u003cem\u003edoesn\u0026#39;t\u003c/em\u003e serve, will be given our index.html. This lets the client-side app handle all the routing.\u003c/li\u003e\n\u003cli\u003eWe read the compiled HTML doc and split it around our \u003ccode\u003enot rendered\u003c/code\u003e statement. Then we can slot in our markup in between the divs, right where it should be. Another strategy you can do here is to make an \u003ccode\u003eHtml.js\u003c/code\u003e component that renders the outer shell of your app. This for now suits our needs\u003c/li\u003e\n\u003cli\u003eWe use renderToString to take our app and render it to a string we can serve as HTML, sandwiched inside our outer HTML.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cblockquote\u003e\n\u003cp\u003eThis code won\u0026#39;t 404 or 500 on bad requests. It\u0026#39;s a lot involved to do that with React Router v6. \u003ca href=\"https://github.com/remix-run/react-router/issues/8286#issuecomment-963845433\"\u003eSee here\u003c/a\u003e to learn more.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eRun \u003ccode\u003enpm run start\u003c/code\u003e and then open \u003ca href=\"http://localhost:3000\"\u003ehttp://localhost:3000\u003c/a\u003e to see your server side rendered app. Notice it displays markup almost instantly.\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eüèÅ \u003ca href=\"https://github.com/btholt/citr-v7-project/tree/master/server-side-rendering-1\"\u003eClick here to see the state of the project up until now: server-side-rendering-1\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n","slug":"server-side-rendering","title":"Server Side Rendering","section":"Server Side Rendering","icon":"server","filePath":"/home/runner/work/complete-intro-to-react-v7/complete-intro-to-react-v7/lessons/13-server-side-rendering/A-server-side-rendering.md","nextSlug":"/complete-intro-to-react-v7/lessons/server-side-rendering/streaming-markup","prevSlug":"/complete-intro-to-react-v7/lessons/code-splitting/code-splitting"}},"__N_SSG":true},"page":"/lessons/[section]/[slug]","query":{"section":"server-side-rendering","slug":"server-side-rendering"},"buildId":"ug4-t9ZxktoWmqoFABkyh","assetPrefix":"/complete-intro-to-react-v7","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>